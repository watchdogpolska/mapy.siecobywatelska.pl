{% extends 'base.html.twig' %}

{% block lat_lng_widget %}
  {{- block('form_widget') -}}
  <div id="{{ id }}_canvas" style="width: 100%; height: 300px;"></div>
{% endblock %}

{% block tetranz_select2entity_widget_select_option %}
  <option
    value="{{ id }}"
    selected="selected"
    data-img="{{ asset('/icons/' ~ data.name ) }}">
    {{ label }}
  </option>
{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css"
    integrity="sha256-xJOZHfpxLR/uhh1BwYFS5fhmOAdIRQaiOul5F/b7v3s="
    crossorigin="anonymous" />
  <style>
    .img-sm{
      height: 1em;
    }
  </style>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script
    type="text/javascript"
    src='https://maps.google.com/maps/api/js?sensor=false&libraries=places&key=AIzaSyDGED8I-MNqAt6Og9owPHo6PEpqRQLgaXA'></script>
  <script
    type="text/javascript"
    src="https://unpkg.com/jquery-locationpicker@0.1.12/dist/locationpicker.jquery.min.js"
    integrity="sha384-v6Or+XGUBtfx9y8Z6pNl4+1agCkqQVNWxrt6NGny15X035yJabzQsjHMKWN3IL8y"
    crossorigin="anonymous"></script>
  <script>
    (function() {
      var $input_lat = $('#point_latlng_lat');
      var $input_lng = $('#point_latlng_lng');
      var $input_address = $('#point_latlng_address');

      var options = {
        radius: 0,
        location: {
          latitude: 52.233333,
          longitude: 21.016667
        },
        zoom: 6,
        inputBinding: {
          latitudeInput: $input_lat,
          longitudeInput: $input_lng,
          locationNameInput: $input_address
        },
        enableAutocomplete: true,

      };

      if(
        $input_lat.val() && !isNaN($input_lat.val()) &&
        $input_lng.val() && !isNaN($input_lng.val()) ){
        options['location'] = {
          latitude: $input_lat.val(),
          longitude: $input_lng.val()
        }
      }

      $('#point_latlng_canvas').locationpicker(options);
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js" integrity="sha256-+mWd/G69S4qtgPowSELIeVAv7+FuL871WXaolgXnrwQ=" crossorigin="anonymous"></script>
  <script src="{{ asset('bundles/tetranzselect2entity/js/select2entity.js') }}"></script>
  <script>
    $.fn.select2entityAjax = function(action) {
      var action = action || {};
      var template = function (item) {
        console.log({item});
        var img = item.img || null;
        if (!img) {
          if (item.element && item.element.dataset.img) {
            img = item.element.dataset.img;
          } else {
            return item.text;
          }
        }
        console.log('<span><img src="' + img + '" class="img-circle img-sm"> ' + item.text + '</span>');
        return $(
          '<span><img src="' + img + '" class="img-circle img-sm"> ' + item.text + '</span>'
        );
      };
      this.select2entity($.extend(action, {
        templateResult: template,
        templateSelection: template
      }));
      return this;
    };
    $('.select2entity').select2entityAjax();
  </script>
{% endblock javascripts %}
